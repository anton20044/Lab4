Список эспериментов:

1) Отключение узла
 - Описание эксперимента: Производим штатное выключение виртуальной машины, которая входит в кластер СУБД PostgreSQL с установленным Patroni и является мастером кластера. Кластер состоит из двум машин (мастер+респлика) - msk-lab-pg01 и msk-lab-pg02. Эксперимент проводится над виртуальной машиной msk-lab-pg01.
 - Ожидаемые результаты: Продвижение виртуальной машины msk-lab-pg02 с роли реплики до роли мастера кластера. Определение времени продвижения реплики до мастера. Определение стратегии выбора нового мастера.
 - Реальные результаты: Реплика продвинута до мастера.
 - Анализ результатов: Реплика продвинута до мастера за 1 секунду. Такое минимальное время обеспечено отсутствием запросов пользователей на вставку и выборку данных в СУБД, т.к. СУБД не находится в продуктиве. При нагрузке на СУБД ожидается увеличение времени переключения. Определить стратегию выбора нового мастера не представляется возможным в текущей конфигурации кластера, т.к. кластер состоит из двух нод и пропадание мастера приводит к продвижению единственной реплики.
 - Приложение: см скриншот Lab4_1

2) Имитация частичной потери сети
 - Описание эксперимента: На мастер СУБД устанавливаем ПО Chaos blade. Имитируем потерю пакетов по сети. 
 - Ожидаемые результаты: Кластер сохранит работоспособное состояние. Увеличится время доставки журналов с мастера на реплику.
 - Реальные результаты: Кластер сохранил работоспособность, увеличилось время доставки журналов с мастера на реплику.
 - Анализ результатов: Из-за увеличения времени доставки журналов с мастера на реплику, увеличилось отставание данных реплики от мастера. На мастере журналы транзакций стали храниться дольше, как следствие уменьшилось свободное дискоевое пространство на нем.
 - Скрипт для Chaos blade: sudo ./blade create network corrupt --percent 40 --destination-ip 10.74.174.6 --interface ens160
 - Приложение: см скриншот Lab4_2_Net_errors - фиксация сетевых ошибок на интерфейсе мастера
 - Приложение: см скриншот Lab4_2_WAL - отображение графика передачи WAL журналов с мастера на реплику

3) Высокая нагрузка на CPU или I/O
 - Описание эксперимента: На мастер СУБД устанавливаем ПО Chaos blade. Имитируем полную загрузку CPU
 - Ожидаемые результаты: Увеличение вревени ответа API, из-за увеличения времени ответа СУБД
 - Реальные результаты: Увеличение вревени ответа API, из-за увеличения времени ответа СУБД
 - Анализ результатов: При одном пользователи и полной нагрузке на CPU мастера в системе мониторинга зафиксировано увеличение времени ответа API до 2,5мс. Без нагрузки время ответа 1,5 мс. Соответственно при увеличении числа запросов время ответа будет увеличиваться, что приведет к негативной реакции со стороны пользователей.
 - Скрипт для Chaos blade: sudo ./blade create cpu fullload
 - Приложение: см скриншот Lab4_3_Load - показывает нагрузку на CPU
 - Приложение: см скриншот Lab4_3_Latency - показывает увеличение времени ответа

4) Тестирование систем мониторинга и оповещения
 - Описание эксперимента: Проводим выключение службы Patroni на виртуальной машины msk-lab-pg01, после получение уведомления о недоступности службы Patroni. Выключаем машину msk-lab-pg01.
 - Ожидаемые результаты: Получение уведомления в телеграм о недоступности службы Patroni на машине msk-lab-pg01, затем о недоступности всей виртуальной машины. Определение времени получения уведомления. 
 - Реальные результаты: Получено уведомление о недоступности службы Patroni на машине msk-lab-pg01, после о недоступности виртуальной машины.
 - Анализ результатов: Система мониторинга работает стабильно, отказы службы и узла регистрируются. Уведомление приходит в течении двух минут. После запуска узла и службы Patroni получены уведомления о восстановлении служб.
 - Приложение: см скриншот Lab4_4

5) ”Split-brain"
 - Описание эксперимента: На реплику СУБД устанавливаем ПО Chaos blade. Имитируем полное отсутствие сети
 - Ожидаемые результаты: Сервера msk-lab-pg01 и msk-lab-pg02 должны быть продвинуты до уровня мастер
 - Реальные результаты: Продвижение реплики до мастера не произошло. Ручная смена лидера кластера СУБД так же не привела к получению двух мастеров.
 - Анализ результатов: Получение ”Split-brain" при отсутсвии связи между мастером и репликой СУБД не возможно, т.к. ключ лидера кластера хранится в кластере etcd.
 - Скрипт для Chaos blade: sudo ./blade create network loss --percent 100 --destination-ip 10.74.174.5  --interface ens160
 - Приложение: см скриншот Lab5_1_No_Net - показывает отсутствие сетевого взаимодействия между мастером и нодой

6) Долгосрочная изоляция
 - Описание эксперимента: Выключаем реплику СУБД msk-lab-pg02 на один час. Вставляем данные в БД на местере.
 - Ожидаемые результаты: После включения реплики журналы транзакций мастера должны быть проиграны на реплики.
 - Реальные результаты: Журналы транзакций были доставлены на реплику и успешно проиграны.
 - Анализ результатов: Долгосрочная изоляция не повлияла на работу кластера. Но было выявлена потенциально опасная тенденция. При активной работе с мастер БД (вставка/изменение данных) и недоступности реплики, файлы журнала транзакций, которые не могут быть переданы на реплику и проиграны, сохраняются на диске. При долгом отсутствии реплики это может привести к заполнению диска на местере, чем вызовет отказ работы СУБД.
 - Скрипт для Chaos blade: sudo ./blade create network loss --percent 100 --destination-ip 10.74.174.5  --interface ens160
 - Приложение: см скриншот Lab4_6 - график отображает запись журналов WAL на реплике после долгосрочной изоляции мастера и реплики


7) Сбои сервисов зависимостей
 - Описание эксперимента: Выключаем две из трех машин с сервисом etcd (msk-lab-etcd01 и msk-lab-etcd03), вызывая этим действием некорректную работу кластера etcd. Затем выключаем виртуальную машину msk-lab-pg02, которая является мастером в кластере СУБД.
 - Ожидаемые результаты: msk-lab-pg01 продвинется до мастера в кластере СУБД.
 - Реальные результаты: msk-lab-pg01 до роли мастера не продвинулась. Служба Patroni несмогла выбрать нового лидера при нерабочем кластере etcd. СУБД на реплике перешло в режим только для чтения.
 - Анализ результатов: При неработающем кластере etcd, перевыбор мастера в кластере СУБД не возможен, т.е. при отказе узла с ролью мастер СУБД перейдет в режим только чтения данных. При восстановлении работы кластера etcd реплика будет продвинута до мастера.
 - Приложение: см скриншот Lab4_7_ETCD_down - график отображает попытку оставшейся ноды ETCD инициировать перевыборы мастера в кластере ETCD
 - Приложение: см скриншот Lab4_7_ETCD_up - график отображает запросы к кластеру ETCD после восстановления ноды, запросы от Patroni
 - Приложение: см скриншот Lab4_7_Patroni - график смены лидера Patroni



